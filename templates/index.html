<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²Œì„ ì •ì‚°í‘œ</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f7f9; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h1, h2 { border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-top: 0; }
        button, select, input { font-size: 14px; padding: 5px; border-radius: 4px; border: 1px solid #ccc; }
        button { background-color: #007bff; color: white; border: none; padding: 8px 12px; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        button.delete-btn { background-color: #dc3545; }
        button.action-btn { background-color: #28a745; }
        .item-row { display: flex; align-items: center; flex-wrap: wrap; gap: 10px; padding: 15px; border: 1px solid #ddd; background-color: #fafafa; }
        #player-list .item-row { border-radius: 0; margin-top: 0; }
        #player-list .item-row + .item-row { border-top: none; }
        #player-list .item-row:first-child { border-top-left-radius: 6px; border-top-right-radius: 6px; }
        #player-list .item-row:last-child { border-bottom-left-radius: 6px; border-bottom-right-radius: 6px; }
        .summary-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.95em; }
        .summary-table th, .summary-table td { border: 1px solid #ddd; padding: 8px; }
        .summary-table th { background-color: #f2f2f2; }
        .date-selector, .rank-selector-wrapper { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-bottom: 20px; padding: 10px; background-color: #e9ecef; border-radius: 6px; }
        .player-entries { display: inline-flex; gap: 5px; align-items: center; background-color: #e9ecef; padding: 5px; border-radius: 4px; min-height: 20px; }
        .player-entries span { background-color: #007bff; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.9em; }
        .dealer-num, .player-num { font-weight: bold; font-size: 1.2em; margin-right: 5px; color: #6c757d; }
        .text-center { text-align: center; }
        .summary-table td, .summary-table th { text-align: center; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 25px; border-radius: 8px; width: 600px; max-height: 80vh; overflow-y: auto; }
        .modal-content h3 { margin-top: 0; }
        .modal-actions { text-align: right; margin-top: 20px; }
        #prize-editor-table input, #rank-editor-table input { width: 100px; text-align: right; }
        #prize-editor-table select, #rank-editor-table select { width: 120px; }
        #game-info-display { font-size: 1.1em; font-weight: bold; margin-bottom: 15px; color: #4a4a4a; border-bottom: 1px solid #e0e0e0; padding-bottom: 8px; }
        #archived-games-list .game-item { padding: 10px; border: 1px solid #eee; margin-top: -1px; cursor: pointer; }
        #archived-games-list .game-item:hover { background-color: #f0f0f0; }
        #archived-games-list .game-item.selected { background-color: #007bff; color: white; border-color: #007bff; }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            h1 { font-size: 1.5em; }
            h2 { font-size: 1.2em; }
            .summary-table { font-size: 0.8em; }
            #dealer-list .item-row { flex-direction: column; align-items: stretch; gap: 12px; }
            .dealer-line { display: flex; align-items: center; gap: 8px; width: 100%; }
            .dealer-line .result { margin-left: auto; }
            #player-list .item-row { flex-wrap: wrap; }
            .player-entries { flex-basis: 100%; margin-top: 10px; justify-content: flex-start; flex-wrap: wrap; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ê²Œì„ ì •ì‚°í‘œ</h1>
    <p style="text-align: center; color: #dc3545; font-size: 0.9em; margin-top: -10px; margin-bottom: 15px;">
        <strong>ì£¼ì˜!</strong> ë™ì‹œ ì ‘ì†ì‹œ ë°ì´í„°ê°€ ì €ì¥ ì•ˆ ë  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ê¼­ í•œëª…ì”© ì ‘ì†ë°”ëë‹ˆë‹¤. ë”œëŸ¬ê°€ ì˜ ì±™ê¸°ê¸°!
    </p>
    <div class="date-selector">
        <input type="date" id="game-date">
        <span id="day-of-week"></span>
        <button id="today-btn">Today</button>
        <select id="tournament-select">
            <option value="t1">í† ë„ˆ1</option>
            <option value="t2">í† ë„ˆ2</option>
            <option value="t3">í† ë„ˆ3</option>
        </select>
    </div>

    <div class="section"><h2>ë”œëŸ¬ ê´€ë¦¬</h2><div id="dealer-list"></div><button id="add-dealer-btn" style="margin-top: 10px;">ë”œëŸ¬ ì¶”ê°€</button></div>
    <div class="section">
        <h2>í”Œë ˆì´ì–´ ê´€ë¦¬</h2>
        <div id="player-list"></div>
        <div style="margin-top: 10px; display: flex; align-items: center; gap: 10px;">
            <button id="add-player-btn">í”Œë ˆì´ì–´ ì¶”ê°€</button>
        </div>
    </div>
    <div class="section">
        <h2>ë“±ìˆ˜ ì§€ì •</h2>
        <div class="rank-selector-wrapper">
            <button id="open-rank-modal-btn">ë“±ìˆ˜ ì§€ì •í•˜ê¸°</button>
        </div>
    </div>
    
    <div id="final-results-area">
        <div class="section">
            <h2 class="text-center">ê²Œì„ ê²°ê³¼</h2>
            <div id="results-summary" class="text-center">
                <div id="game-info-display"></div>
                <h3>ğŸ† í”Œë ˆì´ì–´</h3>
                <table class="summary-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>í”Œë ˆì´ì–´</th>
                            <th>ì…ì¥ë£Œ</th>
                            <th>ì–¼ë¦¬</th>
                            <th>ë°”ì´ì¸</th>
                            <th>ë¦¬ë°”ì´1</th>
                            <th>ë¦¬ë°”ì´2</th>
                        </tr>
                    </thead>
                    <tbody id="player-summary-body"></tbody>
                </table>
                <h3 style="margin-top: 20px;">ğŸ† Prize</h3>
                <div id="prize-pool">ì´ìƒê¸ˆ: 0 í¬ì¸íŠ¸</div>
                <table class="summary-table">
                    <thead><tr><th>ë“±ìˆ˜</th><th>í”Œë ˆì´ì–´</th><th>ìƒê¸ˆ</th><th>ë¹„ìœ¨</th></tr></thead>
                    <tbody id="prize-distribution-body"></tbody>
                </table>
            </div>
        </div>
        <div class="section">
            <h3 class="text-center" style="margin-top: 20px;">ğŸ† ë”œëŸ¬ ì •ì‚°</h3>
            <table class="summary-table">
                <thead><tr><th>#</th><th>ë”œëŸ¬ëª…</th><th>ì‹œì‘ì‹œê°„</th><th>ë§ˆê°ì‹œê°„</th><th>ì´ ê·¼ë¬´ì‹œê°„</th><th>í¬ì¸íŠ¸</th></tr></thead>
                <tbody id="dealer-summary-body"></tbody>
            </table>
        </div>
    </div>
    
    <div id="game-controls" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
        <button id="edit-prize-btn" style="background-color: #ffc107; color: #212529;">ìƒê¸ˆ í˜„í™© ìˆ˜ì •</button>
        <button id="game-end-btn" style="background-color:#6f42c1;">ê²°ê³¼ ì´ë¯¸ì§€ ì €ì¥</button>
    </div>

</div>
<div class="container" style="margin-top:20px; text-align: right;">
    <button id="new-game-btn" style="background-color: #fd7e14;">ìƒˆë¡œìš´ ì •ì‚° ì‹œì‘</button>
    <button id="load-game-btn" style="background-color: #17a2b8;">ì´ì „ ê²Œì„ ë¶ˆëŸ¬ì˜¤ê¸°</button>
</div>

<div id="prize-modal" class="modal-overlay">
    <div class="modal-content">
        <h3>ìƒê¸ˆ í˜„í™© ìˆ˜ì •</h3>
        <p>ì´ìƒê¸ˆ <strong id="modal-total-prize">0</strong> í¬ì¸íŠ¸ë¥¼ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤. í˜„ì¬ í•©ê³„: <strong id="modal-current-sum">0</strong></p>
        <table class="summary-table" id="prize-editor-table">
            <thead><tr><th>ë“±ìˆ˜</th><th>í”Œë ˆì´ì–´</th><th>ìƒê¸ˆ (í¬ì¸íŠ¸)</th><th>ì‚­ì œ</th></tr></thead>
            <tbody></tbody>
        </table>
        <div class="modal-actions">
            <button id="add-rank-btn" type="button" style="float: left;">ë“±ìˆ˜ ì¶”ê°€</button>
            <button id="prize-modal-close-btn" type="button" style="background-color: #6c757d;">ì·¨ì†Œ</button>
            <button id="prize-modal-save-btn" type="button">ìˆ˜ì • ì™„ë£Œ</button>
        </div>
    </div>
</div>

<div id="rank-modal" class="modal-overlay">
    <div class="modal-content">
        <h3>ë“±ìˆ˜ ì§€ì •</h3>
        <table class="summary-table" id="rank-editor-table">
            <thead><tr><th>ë“±ìˆ˜</th><th>í”Œë ˆì´ì–´</th><th>ì˜ˆìƒ ìƒê¸ˆ</th></tr></thead>
            <tbody></tbody>
        </table>
        <div class="modal-actions">
            <button id="rank-modal-close-btn" type="button" style="background-color: #6c757d;">ì·¨ì†Œ</button>
            <button id="rank-modal-save-btn" type="button">ì™„ë£Œ</button>
        </div>
    </div>
</div>

<div id="load-game-modal" class="modal-overlay">
    <div class="modal-content">
        <h3>ì´ì „ ê²Œì„ ë¶ˆëŸ¬ì˜¤ê¸°</h3>
        <div id="archived-games-list">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        <div class="modal-actions">
            <button id="load-game-close-btn" type="button" style="background-color: #6c757d;">ì·¨ì†Œ</button>
            <button id="load-game-confirm-btn" type="button">í™•ì¸</button>
        </div>
    </div>
</div>


<datalist id="dealer-names-list">{% for name in dealers %}<option value="{{ name }}">{% endfor %}</datalist>
<datalist id="player-names-list">{% for name in players %}<option value="{{ name }}">{% endfor %}</datalist>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, deleteDoc, onSnapshot, collection, query, orderBy, getDocs, documentId } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDxwPHSfIlcCii9RLBG9vhwQj2mhjzj3B8",
        authDomain: "holdemresult-8e89d.firebaseapp.com",
        projectId: "holdemresult-8e89d",
        storageBucket: "holdemresult-8e89d.appspot.com",
        messagingSenderId: "73783503951",
        appId: "1:73783503951:web:c0d504d039a163f459ce3a",
        measurementId: "G-EQ5F9VXQWV"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const DEALER_NAMES = {{ dealers | tojson }};
    const PLAYER_NAMES = {{ players | tojson }};
    
    const dealerList = document.getElementById('dealer-list');
    const playerList = document.getElementById('player-list');
    const prizePoolEl = document.getElementById('prize-pool');
    const prizeDistributionBody = document.getElementById('prize-distribution-body');
    const gameDateEl = document.getElementById('game-date');
    const dayOfWeekEl = document.getElementById('day-of-week');
    const rankAssignmentEl = document.getElementById('rank-assignment');
    const dealerSummaryBody = document.getElementById('dealer-summary-body');
    const prizeModal = document.getElementById('prize-modal');
    const tournamentSelect = document.getElementById('tournament-select');
    const gameInfoDisplayEl = document.getElementById('game-info-display');
    const playerSummaryBody = document.getElementById('player-summary-body');
    const rankModal = document.getElementById('rank-modal');
    const loadGameModal = document.getElementById('load-game-modal');
    let totalPrizeForModal = 0;
    
    let isUpdatingFromFirebase = false; 
    let globalRanks = [];

    function addAllEventListeners() {
        document.getElementById('add-dealer-btn').addEventListener('click', addDealerRow);
        document.getElementById('add-player-btn').addEventListener('click', addPlayerRow);
        document.getElementById('today-btn').addEventListener('click', setToday);
        document.getElementById('new-game-btn').addEventListener('click', startNewGame);
        document.getElementById('game-end-btn').addEventListener('click', endGameAndCapture);
        document.getElementById('edit-prize-btn').addEventListener('click', openPrizeModal);
        document.getElementById('open-rank-modal-btn').addEventListener('click', openRankModal);
        document.getElementById('load-game-btn').addEventListener('click', openLoadGameModal);
        rankModal.addEventListener('click', handleRankModalActions);
        loadGameModal.addEventListener('click', handleLoadGameModalActions);
        dealerList.addEventListener('click', handleDealerActions);
        dealerList.addEventListener('change', handleDealerInputs);
        playerList.addEventListener('click', handlePlayerActions);
        playerList.addEventListener('change', handlePlayerInputs);
        prizeModal.addEventListener('click', handleModalActions);
        prizeModal.addEventListener('input', handleModalInputs);
        gameDateEl.addEventListener('change', updateDayOfWeek);
        tournamentSelect.addEventListener('change', updateAll);
    }
    
    function setupRealtimeListener() {
        const docRef = doc(db, "gameStates", "latestState");
        onSnapshot(docRef, (docSnap) => {
            console.log("Firebase ë°ì´í„° ë³€ê²½ ê°ì§€!");
            const newState = docSnap.exists() ? docSnap.data() : null;
            const currentState = getCurrentState();
            if (JSON.stringify(newState) === JSON.stringify(currentState)) {
                console.log("ìƒíƒœ ë™ì¼, í™”ë©´ ê°±ì‹  ì•ˆ í•¨.");
                return;
            }
            isUpdatingFromFirebase = true;
            if (newState) {
                restoreState(newState);
            } else {
                console.log("DBì— ë°ì´í„° ì—†ìŒ. ìƒˆë¡œ ì‹œì‘í•©ë‹ˆë‹¤.");
                resetUI(false); 
            }
            setTimeout(() => { isUpdatingFromFirebase = false; }, 500);
        });
    }

    async function saveStateToFirebase() {
        if (isUpdatingFromFirebase) {
            console.log("Firebase ë°ì´í„° ë³µì› ì¤‘ì´ë¯€ë¡œ ì €ì¥ì„ ê±´ë„ˆëœë‹ˆë‹¤.");
            return;
        }
        const state = getCurrentState();
        try {
            await setDoc(doc(db, "gameStates", "latestState"), state);
            console.log("ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ìë™ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch (error) {
            console.error("Firebase ì €ì¥ ì‹¤íŒ¨! ìƒì„¸ ì˜¤ë¥˜:", error);
        }
    }
    
    function getCurrentState() {
        return {
            date: gameDateEl.value,
            tournamentId: tournamentSelect.value,
            dealers: Array.from(document.querySelectorAll('#dealer-list .item-row')).map(row => ({ name: row.querySelector('.dealer-name').value, startHour: row.querySelector('.start-hour').value, startMinute: row.querySelector('.start-minute').value, endHour: row.querySelector('.end-hour').value, endMinute: row.querySelector('.end-minute').value, resultHTML: row.querySelector('.result').innerHTML, isClosed: row.querySelector('.close-btn').disabled, })),
            players: Array.from(document.querySelectorAll('#player-list .item-row')).map(row => ({ name: row.querySelector('.player-name').value, entryFee: row.querySelector('.entry-fee').checked, earlyBird: row.querySelector('.early-bird').checked, entries: JSON.parse(row.dataset.entries || '[]'), })),
            ranks: globalRanks,
            customPrizes: JSON.parse(prizeDistributionBody.dataset.customPrizes || 'null'),
        };
    }
    function restoreState(state) {
        dealerList.innerHTML = '';
        playerList.innerHTML = '';
        gameDateEl.value = state.date;
        tournamentSelect.value = state.tournamentId || 't1';
        updateDayOfWeek();
        (state.dealers || []).forEach(data => addDealerRow(data, false));
        (state.players || []).forEach(data => addPlayerRow(data, false));
        if (state.customPrizes) { prizeDistributionBody.dataset.customPrizes = JSON.stringify(state.customPrizes); }
        globalRanks = state.ranks || [];
        updateAll(null, false);
    }
    
    function updateAll(ranksToRestore = [], doSave = true) {
        renumberDealers();
        renumberPlayers();
        updateGameSummary();
        updateDealerSummaryTable();
        updatePlayerSummaryTable();
        updateGameInfoDisplay();
        if (doSave) {
            saveStateToFirebase();
        }
    }
    
    async function startNewGame() {
        if (confirm('ìƒˆë¡œìš´ ê²Œì„ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            try {
                const latestStateRef = doc(db, "gameStates", "latestState");
                const docSnap = await getDoc(latestStateRef);

                if (docSnap.exists()) {
                    const currentStateData = docSnap.data();
                    if (currentStateData.players && currentStateData.players.length > 0) {
                        const now = new Date();
                        const datePart = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
                        const timePart = String(now.getHours()).padStart(2, '0') + '-' + String(now.getMinutes()).padStart(2, '0') + '-' + String(now.getSeconds()).padStart(2, '0');
                        const archiveId = `${datePart}_${timePart}`;

                        const archiveRef = doc(db, "archivedGames", archiveId);
                        await setDoc(archiveRef, currentStateData);
                        console.log(`ê¸°ì¡´ ê²Œì„ì´ ${archiveId}ë¡œ ë³´ê´€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    }
                }

                const today = new Date();
                const newGameDate = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
                const emptyState = { date: newGameDate, tournamentId: 't1', dealers: [], players: [], ranks: [], customPrizes: null };
                await setDoc(latestStateRef, emptyState);
                
            } catch (error) {
                console.error("ìƒˆ ê²Œì„ ì‹œì‘ ì˜¤ë¥˜:", error);
                alert("ìƒˆ ê²Œì„ì„ ì‹œì‘í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        }
    }

    function resetUI(doUpdate = true) {
        dealerList.innerHTML = '';
        playerList.innerHTML = '';
        prizeDistributionBody.removeAttribute('data-custom-prizes');
        globalRanks = [];
        if (doUpdate) updateAll(null, false);
    }
    function endGameAndCapture() { if (confirm('ê²°ê³¼ë¥¼ ì´ë¯¸ì§€ë¡œ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { html2canvas(document.getElementById('final-results-area'), { scale: 2 }).then(canvas => { const link = document.createElement('a'); const tourneyText = tournamentSelect.options[tournamentSelect.selectedIndex].text; link.download = `ê²Œì„ì •ì‚°_${gameDateEl.value}_${tourneyText}.png`; link.href = canvas.toDataURL('image/png'); link.click(); }); } }

    const KOREAN_DAYS = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
    function setToday() { const today = new Date(); gameDateEl.value = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0'); updateDayOfWeek(); }
    function updateDayOfWeek() { const selectedDate = new Date(gameDateEl.value); const dayIndex = new Date(selectedDate.getUTCFullYear(), selectedDate.getUTCMonth(), selectedDate.getUTCDate()).getDay(); dayOfWeekEl.textContent = `(${KOREAN_DAYS[dayIndex]})`; updateGameInfoDisplay(); updateAll(); }
    function updateGameInfoDisplay() { const date = gameDateEl.value; const dayOfWeek = dayOfWeekEl.textContent; const tournamentText = tournamentSelect.options[tournamentSelect.selectedIndex].text; if (date) { gameInfoDisplayEl.textContent = `${date} ${dayOfWeek} / ${tournamentText}`; } else { gameInfoDisplayEl.textContent = ''; } }
    
    function renumberDealers() { document.querySelectorAll('#dealer-list .item-row').forEach((row, index) => { let numEl = row.querySelector('.dealer-num'); if (!numEl) { numEl = document.createElement('strong'); numEl.className = 'dealer-num'; row.prepend(numEl); } numEl.textContent = `${index + 1}.`; }); }
    
    function addDealerRow(data = {}, doUpdate = true) {
        const row = document.createElement('div'); row.className = 'item-row';
        const hourOptions = Array.from({ length: 24 }, (_, i) => `<option value="${i}">${String(i).padStart(2, '0')}</option>`).join('');
        const minOptions = Array.from({ length: 60 }, (_, i) => `<option value="${i}">${String(i).padStart(2, '0')}</option>`).join('');
        row.innerHTML = `<div class="dealer-line"><strong class="dealer-num"></strong><select class="dealer-name">${createDropdownOptions(DEALER_NAMES, data.name, true)}</select></div><div class="dealer-line"><strong>ì‹œì‘:</strong> <select class="start-hour">${hourOptions}</select>:<select class="start-minute">${minOptions}</select> <button class="action-btn start-now-btn">NOW</button></div><div class="dealer-line"><strong>ë§ˆê°:</strong> <select class="end-hour">${hourOptions}</select>:<select class="end-minute">${minOptions}</select> <button class="action-btn end-now-btn">NOW</button></div><div class="dealer-line"><button class="action-btn close-btn">ê³„ì‚°</button> <button class="delete-btn">ì‚­ì œ</button> <div class="result">${data.resultHTML || ''}</div></div>`;
        dealerList.appendChild(row);
        if (data.startHour) row.querySelector('.start-hour').value = data.startHour; if (data.startMinute) row.querySelector('.start-minute').value = data.startMinute;
        if (data.endHour) row.querySelector('.end-hour').value = data.endHour; if (data.endMinute) row.querySelector('.end-minute').value = data.endMinute;
        if (data.isClosed) { row.querySelectorAll('select, .action-btn, .close-btn').forEach(el => el.disabled = true); row.querySelector('.delete-btn').disabled = false; }
        if (doUpdate) updateAll();
    }

    function handleDealerActions(e) { const target = e.target; const row = target.closest('.item-row'); if (!row) return; if (target.matches('.delete-btn')) { row.remove(); updateAll(); } else if (target.matches('.start-now-btn')) { const now = new Date(); row.querySelector('.start-hour').value = now.getHours(); row.querySelector('.start-minute').value = now.getMinutes(); updateAll(); } else if (target.matches('.end-now-btn')) { const now = new Date(); row.querySelector('.end-hour').value = now.getHours(); row.querySelector('.end-minute').value = now.getMinutes(); updateAll(); } else if (target.matches('.close-btn')) { const baseDate = gameDateEl.value; if (!baseDate) { alert("ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”."); return; } const startTime = new Date(`${baseDate}T${String(row.querySelector('.start-hour').value).padStart(2, '0')}:${String(row.querySelector('.start-minute').value).padStart(2, '0')}`); const endTime = new Date(`${baseDate}T${String(row.querySelector('.end-hour').value).padStart(2, '0')}:${String(row.querySelector('.end-minute').value).padStart(2, '0')}`); if (endTime < startTime) endTime.setDate(endTime.getDate() + 1); const durationMinutes = Math.round((endTime - startTime) / (1000 * 60)); const points = durationMinutes * 5; row.querySelector('.result').innerHTML = `<span>${durationMinutes}</span>ë¶„, <span>${points.toLocaleString()}</span>í¬ì¸íŠ¸`; row.querySelectorAll('select, .action-btn, .close-btn').forEach(el => el.disabled = true); row.querySelector('.delete-btn').disabled = false; updateAll(); } }
    
    function handleDealerInputs(e) {
        const target = e.target;
        const row = target.closest('.item-row');
        if (!row) return;

        if (target.matches('.dealer-name')) {
            if (target.value === '__DIRECT_INPUT__') {
                const customName = prompt('ë”œëŸ¬ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”:', '');
                if (customName && customName.trim() !== '') {
                    const newName = customName.trim();
                    const newOption = new Option(newName, newName);
                    target.add(newOption);
                    target.value = newName;
                } else {
                    target.value = '';
                }
            }
            updateAll();
        } else if (target.matches('.start-hour, .start-minute, .end-hour, .end-minute')) {
            updateAll();
        }
    }
    
    function updateDealerSummaryTable() { dealerSummaryBody.innerHTML = ''; document.querySelectorAll('#dealer-list .item-row').forEach((row, index) => { if (row.querySelector('.close-btn').disabled) { const name = row.querySelector('.dealer-name').value; const startTime = `${String(row.querySelector('.start-hour').value).padStart(2, '0')}:${String(row.querySelector('.start-minute').value).padStart(2, '0')}`; const endTime = `${String(row.querySelector('.end-hour').value).padStart(2, '0')}:${String(row.querySelector('.end-minute').value).padStart(2, '0')}`; const resultSpans = row.querySelectorAll('.result span'); const minutes = resultSpans[0] ? resultSpans[0].textContent : 'N/A'; const points = resultSpans[1] ? resultSpans[1].textContent : 'N/A'; const tr = document.createElement('tr'); tr.innerHTML = `<td>${index + 1}</td><td>${name}</td><td>${startTime}</td><td>${endTime}</td><td>${minutes} ë¶„</td><td>${points} í¬ì¸íŠ¸</td>`; dealerSummaryBody.appendChild(tr); } }); }
    
    function resetPrizeAndRanks() {
        console.log("í”Œë ˆì´ì–´ ìˆ˜ ë˜ëŠ” ì´ë¦„ ë³€ê²½: ë“±ìˆ˜ ë° ìƒê¸ˆ ì •ë³´ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.");
        globalRanks = [];
        prizeDistributionBody.removeAttribute('data-custom-prizes');
    }

    function renumberPlayers() { document.querySelectorAll('#player-list .item-row').forEach((row, index) => { let numEl = row.querySelector('.player-num'); if (!numEl) { numEl = document.createElement('strong'); numEl.className = 'player-num'; row.prepend(numEl); } numEl.textContent = `${index + 1}.`; }); }
    
    function addPlayerRow(data = {}, doUpdate = true) {
        const row = document.createElement('div'); row.className = 'item-row player-row';
        row.dataset.entries = JSON.stringify(data.entries || []);
        let playerOptionsHTML = createDropdownOptions(PLAYER_NAMES, data.name, true);
        if (data.name && !PLAYER_NAMES.includes(data.name)) { playerOptionsHTML += `<option value="${data.name}" selected>${data.name}</option>`; }
        row.innerHTML = `<strong class="player-num"></strong><select class="player-name">${playerOptionsHTML}</select> <label><input type="checkbox" class="entry-fee" ${data.entryFee ? 'checked' : ''}> ì…ì¥ë£Œ</label> <label><input type="checkbox" class="early-bird" ${data.earlyBird ? 'checked' : ''}> ì–¼ë¦¬</label> <select class="entry-type"><option value="ì…ê¸ˆ">ì…ê¸ˆ</option><option value="í¬ì¸íŠ¸">í¬ì¸íŠ¸</option></select> <button class="action-btn add-entry-btn">í™•ì¸</button> <div class="player-entries"></div> <button class="delete-btn" style="margin-left: auto;">ì‚­ì œ</button>`;
        playerList.appendChild(row);
        if (data.name) { row.querySelector('.player-name').value = data.name; }
        renderPlayerEntries(row);
        
        if (doUpdate) {
            resetPrizeAndRanks();
            updateAll();
        }
    }

    function renderPlayerEntries(row) { const entries = JSON.parse(row.dataset.entries || '[]'); const container = row.querySelector('.player-entries'); container.innerHTML = entries.map(entry => `<span>${entry}</span>`).join(''); const maxEntries = 1 + (row.querySelector('.early-bird').checked ? 2 : 1); row.querySelector('.add-entry-btn').disabled = entries.length >= maxEntries; }
    
    function handlePlayerActions(e) { 
        const target = e.target; 
        const row = target.closest('.player-row'); 
        if (!row) return; 

        if (target.matches('.add-entry-btn')) { 
            const entries = JSON.parse(row.dataset.entries); 
            entries.push(row.querySelector('.entry-type').value); 
            row.dataset.entries = JSON.stringify(entries); 
            renderPlayerEntries(row); 
            updateAll(); 
        } else if (target.matches('.delete-btn')) { 
            const entries = JSON.parse(row.dataset.entries); 
            if (entries.length > 0) { 
                entries.pop(); 
                row.dataset.entries = JSON.stringify(entries); 
                renderPlayerEntries(row); 
                updateAll();
            } else { 
                row.remove(); 
                resetPrizeAndRanks();
                updateAll();
            } 
        } 
    }

    function handlePlayerInputs(e) { 
        const target = e.target; 
        const row = target.closest('.player-row'); 
        if (!row) return; 
        
        if (target.matches('.player-name')) { 
            if (target.value === '__DIRECT_INPUT__') { 
                const customName = prompt('í”Œë ˆì´ì–´ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”:', ''); 
                if (customName && customName.trim() !== '') { 
                    const newName = customName.trim();
                    const newOption = new Option(newName, newName);
                    target.add(newOption);
                    target.value = newName;
                } else { 
                    target.value = ''; 
                } 
            } 
            resetPrizeAndRanks();
            updateAll(); 
        } else if (target.matches('.entry-fee') || target.matches('.early-bird')) { 
            renderPlayerEntries(row); 
            updateAll(); 
        } 
    }
    
    function updatePlayerSummaryTable() {
        playerSummaryBody.innerHTML = '';
        document.querySelectorAll('#player-list .item-row').forEach((row, index) => {
            const name = row.querySelector('.player-name').value;
            if (!name) return;
            const entryFee = row.querySelector('.entry-fee').checked ? 'O' : 'X';
            const earlyBird = row.querySelector('.early-bird').checked ? 'O' : 'X';
            const entries = JSON.parse(row.dataset.entries || '[]');
            const buyIn = entries[0] || '';
            const rebuy1 = entries[1] || '';
            const rebuy2 = entries[2] || '';
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${index + 1}</td><td>${name}</td><td>${entryFee}</td><td>${earlyBird}</td><td>${buyIn}</td><td>${rebuy1}</td><td>${rebuy2}</td>`;
            playerSummaryBody.appendChild(tr);
        });
    }
    
    function updateGameSummary() { let prizeBuyInCount = 0; const playerRows = document.querySelectorAll('.player-row'); playerRows.forEach(row => { prizeBuyInCount += JSON.parse(row.dataset.entries || '[]').length; }); const totalPrize = prizeBuyInCount * 250; totalPrizeForModal = totalPrize; prizePoolEl.textContent = `ì´ìƒê¸ˆ: ${totalPrize.toLocaleString()} í¬ì¸íŠ¸`; const customPrizes = JSON.parse(prizeDistributionBody.dataset.customPrizes || 'null'); if (customPrizes) { renderCustomPrizes(customPrizes); } else { calculatePrizeDistribution(totalPrize, playerRows.length); } }
    function calculatePrizeDistribution(totalPrize, playerCount) {
        prizeDistributionBody.innerHTML = '';
        const prizeConfig = prizeConfigForCount(playerCount);
        if (prizeConfig.length > 0) {
            prizeConfig.forEach((p, index) => {
                const winnerName = globalRanks[index] || '';
                const prize = Math.round(totalPrize * p.p);
                prizeDistributionBody.innerHTML += `<tr><td>${p.r}ë“±</td><td>${winnerName}</td> <td>${prize.toLocaleString()} í¬ì¸íŠ¸</td> <td>${(p.p * 100).toFixed(0)}%</td></tr>`;
            });
        }
    }
    
    function openRankModal() {
        const editorBody = rankModal.querySelector('#rank-editor-table tbody');
        editorBody.innerHTML = ''; 

        const players = Array.from(document.querySelectorAll('#player-list .player-name'))
                             .map(select => select.value)
                             .filter(name => name);
        const playerCount = players.length;

        const prizeConfig = prizeConfigForCount(playerCount);

        if (prizeConfig.length === 0) {
            alert("í”Œë ˆì´ì–´ ìˆ˜ê°€ 5ëª… ë¯¸ë§Œì´ë¼ ë“±ìˆ˜ë¥¼ ì§€ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        prizeConfig.forEach((config, index) => {
            const rankText = `${config.r}ë“±`; 
            const prizeAmount = Math.round(totalPrizeForModal * config.p);
            const previouslySelectedPlayer = globalRanks[index] || ''; 
            
            addRankEditorRow({
                rank: rankText,
                player: previouslySelectedPlayer,
                prize: prizeAmount
            }, players);
        });

        rankModal.style.display = 'flex';
    }

    function addRankEditorRow(data = {}, players) {
        const editorBody = rankModal.querySelector('#rank-editor-table tbody');
        const tr = document.createElement('tr');
        const playerOptions = createDropdownOptions(players, data.player);
        tr.innerHTML = `
            <td>${data.rank}</td>
            <td><select class="modal-player">${playerOptions}</select></td>
            <td>${data.prize.toLocaleString()} í¬ì¸íŠ¸</td>`;
        editorBody.appendChild(tr);
    }
    function handleRankModalActions(e) {
        const target = e.target;
        if (target.matches('#rank-modal-close-btn') || !target.closest('.modal-content')) {
            rankModal.style.display = 'none';
        } else if (target.matches('#rank-modal-save-btn')) {
            const selectedRanks = [];
            const selectedPlayers = new Set();
            let isDuplicate = false;
            rankModal.querySelectorAll('.modal-player').forEach(select => {
                const player = select.value;
                if(player && selectedPlayers.has(player)){
                    isDuplicate = true;
                }
                if(player) {
                    selectedPlayers.add(player);
                }
                selectedRanks.push(player);
            });

            if(isDuplicate){
                alert('ì¤‘ë³µëœ í”Œë ˆì´ì–´ê°€ ìˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.');
                return;
            }

            globalRanks = selectedRanks;
            rankModal.style.display = 'none';
            updateAll();
        }
    }

    function openPrizeModal() {
        const editorBody = prizeModal.querySelector('#prize-editor-table tbody');
        editorBody.innerHTML = '';
        const players = Array.from(document.querySelectorAll('#player-list .player-name')).map(select => select.value).filter(name => name);
        const customPrizes = JSON.parse(prizeDistributionBody.dataset.customPrizes || 'null');
        
        document.getElementById('modal-total-prize').textContent = totalPrizeForModal.toLocaleString();
        
        if (customPrizes) {
            customPrizes.forEach(prize => addPrizeEditorRow(prize, players));
        } else {
            const prizeConfig = prizeConfigForCount(players.length);
            prizeConfig.forEach((p, index) => {
                const prize = Math.round(totalPrizeForModal * p.p);
                addPrizeEditorRow({ rank: `${p.r}ë“±`, player: globalRanks[index] || '', prize: prize }, players);
            });
        }
        
        updateModalSum();
        prizeModal.style.display = 'flex';
    }
    function addPrizeEditorRow(data = {}, players) {
        const editorBody = prizeModal.querySelector('#prize-editor-table tbody');
        const tr = document.createElement('tr');
        const playerOptions = createDropdownOptions(players, data.player);
        tr.innerHTML = `
            <td><input type="text" class="modal-rank" value="${data.rank || ''}" placeholder="ì˜ˆ: 1ë“±"></td>
            <td><select class="modal-player">${playerOptions}</select></td>
            <td><input type="number" class="modal-prize" value="${data.prize || 0}"></td>
            <td><button type="button" class="delete-btn">X</button></td>`;
        editorBody.appendChild(tr);
    }
    function handleModalActions(e) {
        const target = e.target;
        if (target.matches('#prize-modal-close-btn') || !target.closest('.modal-content')) {
            prizeModal.style.display = 'none';
        } else if (target.matches('#prize-modal-save-btn')) {
            const currentSum = parseInt(document.getElementById('modal-current-sum').textContent.replace(/,/g, ''));
            if (currentSum !== totalPrizeForModal) {
                alert(`ìƒê¸ˆ í•©ê³„(${currentSum.toLocaleString()})ê°€ ì´ìƒê¸ˆ(${totalPrizeForModal.toLocaleString()})ê³¼ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
                return;
            }
            const newCustomPrizes = Array.from(prizeModal.querySelectorAll('#prize-editor-table tbody tr')).map(tr => ({
                rank: tr.querySelector('.modal-rank').value,
                player: tr.querySelector('.modal-player').value,
                prize: parseInt(tr.querySelector('.modal-prize').value) || 0,
            }));
            prizeDistributionBody.dataset.customPrizes = JSON.stringify(newCustomPrizes);
            prizeModal.style.display = 'none';
            updateAll();
        } else if (target.matches('#add-rank-btn')) {
            const players = Array.from(document.querySelectorAll('#player-list .player-name')).map(select => select.value).filter(name => name);
            addPrizeEditorRow({}, players);
        } else if (target.matches('.delete-btn')) {
            target.closest('tr').remove();
            updateModalSum();
        }
    }
    function updateModalSum() {
        const sum = Array.from(prizeModal.querySelectorAll('.modal-prize'))
            .reduce((total, input) => total + (parseInt(input.value) || 0), 0);
        const currentSumEl = document.getElementById('modal-current-sum');
        currentSumEl.textContent = sum.toLocaleString();
        if (sum !== totalPrizeForModal) {
            currentSumEl.style.color = 'red';
        } else {
            currentSumEl.style.color = 'green';
        }
    }
    function handleModalInputs(e) {
        if (e.target.matches('.modal-prize')) {
            updateModalSum();
        }
    }
    function renderCustomPrizes(customPrizes) {
        prizeDistributionBody.innerHTML = '';
        if(customPrizes && customPrizes.length > 0) {
            customPrizes.forEach(p => {
                const totalPrize = totalPrizeForModal;
                const percentage = totalPrize > 0 ? ((p.prize / totalPrize) * 100).toFixed(0) + '%' : '0%';
                prizeDistributionBody.innerHTML += `<tr><td>${p.rank}</td><td>${p.player}</td> <td>${p.prize.toLocaleString()} í¬ì¸íŠ¸</td> <td>${percentage}</td></tr>`;
            });
        }
    }
    
    // --- ì—¬ê¸°ë¶€í„° ìˆ˜ì •ëœ(êµ¬í˜„ëœ) ì½”ë“œì…ë‹ˆë‹¤ ---
    async function openLoadGameModal() {
        const listEl = document.getElementById('archived-games-list');
        listEl.innerHTML = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
        loadGameModal.style.display = 'flex';

        try {
            // Firebase ëŒ€ì‹  ë¸Œë¼ìš°ì €ì—ì„œ ì§ì ‘ ì •ë ¬í•˜ê¸° ìœ„í•´ query ìˆ˜ì •
            const gamesCollectionRef = collection(db, "archivedGames");
            const querySnapshot = await getDocs(gamesCollectionRef);
            
            listEl.innerHTML = '';
            if (querySnapshot.empty) {
                listEl.innerHTML = 'ë³´ê´€ëœ ê²Œì„ì´ ì—†ìŠµë‹ˆë‹¤.';
                return;
            }
            
            // 1. ê°€ì ¸ì˜¨ ë°ì´í„°ë¥¼ ë°°ì—´ë¡œ ë³€í™˜
            const games = [];
            querySnapshot.forEach(doc => {
                games.push({ id: doc.id, data: doc.data() });
            });

            // 2. ë°°ì—´ì„ ID(ë‚ ì§œ/ì‹œê°„) ê¸°ì¤€ìœ¼ë¡œ ìµœì‹ ìˆœ ì •ë ¬
            games.sort((a, b) => b.id.localeCompare(a.id));

            // 3. ì •ë ¬ëœ ë°°ì—´ì„ ê¸°ë°˜ìœ¼ë¡œ ëª©ë¡ ìƒì„±
            games.forEach(game => {
                const gameData = game.data;
                const playerCount = gameData.players ? gameData.players.length : 0;
                const item = document.createElement('div');
                item.className = 'game-item';
                item.textContent = `[${game.id.replace('_', ' ')}] - í”Œë ˆì´ì–´: ${playerCount}ëª…`;
                item.dataset.id = game.id;
                listEl.appendChild(item);
            });

        } catch(error) {
            console.error("ë³´ê´€ëœ ê²Œì„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
            listEl.innerHTML = 'ê²Œì„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
        }
    }
    // --- ì—¬ê¸°ê¹Œì§€ ìˆ˜ì •ëœ(êµ¬í˜„ëœ) ì½”ë“œì…ë‹ˆë‹¤ ---
    
    async function handleLoadGameModalActions(e) {
        const target = e.target;
        const listEl = document.getElementById('archived-games-list');

        if(target.matches('.game-item')) {
            listEl.querySelectorAll('.game-item').forEach(el => el.classList.remove('selected'));
            target.classList.add('selected');
        } else if (target.matches('#load-game-close-btn') || !target.closest('.modal-content')) {
            loadGameModal.style.display = 'none';
        } else if (target.matches('#load-game-confirm-btn')) {
            const selectedItem = listEl.querySelector('.game-item.selected');
            if (!selectedItem) {
                alert('ë¶ˆëŸ¬ì˜¬ ê²Œì„ì„ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            const gameId = selectedItem.dataset.id;
            try {
                const archiveDocRef = doc(db, "archivedGames", gameId);
                const docSnap = await getDoc(archiveDocRef);

                if (docSnap.exists()) {
                    const gameDataToLoad = docSnap.data();
                    const latestStateRef = doc(db, "gameStates", "latestState");
                    await setDoc(latestStateRef, gameDataToLoad);
                    loadGameModal.style.display = 'none';
                } else {
                    alert('ì„ íƒí•œ ê²Œì„ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch(error) {
                console.error("ê²Œì„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
                alert('ê²Œì„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }
    }
    
    function createDropdownOptions(names, selectedValue, withDirectInputOption = false) { let optionsHtml = ''; if (withDirectInputOption) { optionsHtml += `<option value="__DIRECT_INPUT__">-- ì§ì ‘ì…ë ¥ --</option>`; } optionsHtml += names.map(name => `<option value="${name}" ${name === selectedValue ? 'selected' : ''}>${name}</option>`).join(''); return `<option value="">--ì„ íƒ--</option>` + optionsHtml; }
    function prizeConfigForCount(count) { if (count >= 5 && count <= 7) return [{ r: 1, p: 0.65 }, { r: 2, p: 0.35 }]; if (count >= 8 && count <= 11) return [{ r: 1, p: 0.60 }, { r: 2, p: 0.30 }, { r: 3, p: 0.10 }]; if (count >= 12 && count <= 17) return [{ r: 1, p: 0.50 }, { r: 2, p: 0.25 }, { r: 3, p: 0.15 }, { r: 4, p: 0.10 }]; if (count >= 18 && count <= 35) return [{ r: 1, p: 0.45 }, { r: 2, p: 0.25 }, { r: 3, p: 0.15 }, { r: 4, p: 0.10 }, { r: 5, p: 0.05 }]; return []; }
    
    document.addEventListener('DOMContentLoaded', () => {
        addAllEventListeners();
        setupRealtimeListener();
    });
</script>
</body>
</html>